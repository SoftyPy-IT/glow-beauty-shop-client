name: Node.js CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -euo pipefail

            # Config
            APP_DIR="/var/www/html/neelabh/client"
            REPO_SSH="git@github.com:SoftyPy-IT/neelabh-client.git"
            REPO_HTTPS="https://github.com/SoftyPy-IT/neelabh-client.git"
            BRANCH="main"
            PM2_NAME="neelabh-client"

            # Ensure base dir exists (create parent directories if necessary)
            if [ ! -d "$(dirname "$APP_DIR")" ]; then
              mkdir -p "$(dirname "$APP_DIR")"
            fi

            # If the project directory doesn't exist, try to clone; prefer SSH then HTTPS
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "Project not found at $APP_DIR — attempting to clone."
              if command -v git >/dev/null 2>&1; then
                if git ls-remote "$REPO_SSH" >/dev/null 2>&1; then
                  git clone --depth 1 --branch "$BRANCH" "$REPO_SSH" "$APP_DIR" || true
                else
                  git clone --depth 1 --branch "$BRANCH" "$REPO_HTTPS" "$APP_DIR"
                fi
              else
                echo "ERROR: git is not installed on the server."
                exit 1
              fi
            fi

            # Enter the project directory
            cd "$APP_DIR"

            # Ensure git exists, fetch latest and reset branch to remote
            if command -v git >/dev/null 2>&1; then
              git fetch --all --prune
              git checkout "$BRANCH"
              git reset --hard "origin/$BRANCH"
            else
              echo "WARNING: git not available. Skipping git fetch/reset."
            fi

            # Copy .env only if it doesn't exist
            if [ -f .env.example ]; then
              cp -f .env.example .env
              echo ".env overwritten from .env.example"
            else
              echo ".env.example not found; skipping .env setup."
            fi

            # Install dependencies (clean install). Use --legacy-peer-deps if you need it.
            if command -v npm >/dev/null 2>&1; then
              npm ci --legacy-peer-deps || npm install --legacy-peer-deps
            else
              echo "ERROR: npm is not installed on the server."
              exit 1
            fi

            # Build
            npm run build

            # Ensure pm2 is installed globally
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "pm2 not found — installing globally"
              npm install -g pm2
            fi

            # Start or restart the app with pm2
            if pm2 describe "$PM2_NAME" >/dev/null 2>&1; then
              pm2 restart "$PM2_NAME"
            else
              # Start the app using npm script 'start' (adjust if you use a different start command)
              pm2 start npm --name "$PM2_NAME" -- run start
            fi

            # Persist pm2 process list so it comes back on reboot (requires pm2 startup configured separately)
            pm2 save

            echo "Deployment finished."
